<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>FS Fire — Admin Panel</title>
<meta name="theme-color" content="#0d1117"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
    font-family:-apple-system,'Segoe UI',Helvetica,Arial,sans-serif;
    background:#0d1117;color:#e5e7eb;min-height:100vh;
    -webkit-font-smoothing:antialiased;
}
a{color:#3b82f6;text-decoration:none}
a:hover{text-decoration:underline}

/* ── Auth Overlay ── */
.auth-overlay{
    position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;
    background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
}
.auth-box{
    background:#161b22;border:2px solid #30363d;border-radius:12px;
    padding:32px 28px;text-align:center;max-width:380px;width:90%;
    box-shadow:0 16px 48px rgba(0,0,0,.6);
}
.auth-box h2{font-size:20px;font-weight:800;color:#fff;margin-bottom:4px}
.auth-box h2 span{color:#f41216}
.auth-box p{color:#6b7280;font-size:13px;margin-bottom:20px}
.auth-input{
    width:100%;padding:12px 14px;background:rgba(255,255,255,.06);
    border:1px solid #30363d;border-radius:8px;color:#e5e7eb;
    font-size:16px;font-family:inherit;outline:none;margin-bottom:12px;
    transition:border-color .15s;
}
.auth-input:focus{border-color:#f41216}
.auth-input::placeholder{color:#4b5563}
.auth-btn{
    width:100%;padding:12px;background:rgba(244,18,22,.2);border:1px solid rgba(244,18,22,.4);
    border-radius:8px;color:#f41216;font-size:15px;font-weight:700;cursor:pointer;
    transition:background .15s;letter-spacing:.5px;
}
.auth-btn:hover{background:rgba(244,18,22,.3)}
.auth-error{color:#ef4444;font-size:13px;margin-top:10px;display:none}

/* ── Header ── */
.header{
    background:#161b22;border-bottom:1px solid #30363d;
    padding:16px;display:flex;align-items:center;gap:12px;
    position:sticky;top:0;z-index:10;
}
.header::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(244,18,22,.3) 50%,transparent)}
.header .brand{display:flex;align-items:center;gap:8px;flex:1}
.header svg{width:22px;height:22px;fill:#f41216}
.header h1{font-size:18px;font-weight:800;color:#fff}
.header h1 span{color:#f41216}
.admin-tag{
    font-size:10px;font-weight:800;letter-spacing:1px;text-transform:uppercase;
    padding:3px 10px;border-radius:4px;
    background:rgba(244,18,22,.15);color:#f41216;border:1px solid rgba(244,18,22,.3);
}
.logout-btn{
    font-size:12px;color:#6b7280;cursor:pointer;padding:6px 10px;
    border-radius:6px;border:1px solid #30363d;background:transparent;
    transition:color .15s,border-color .15s;
}
.logout-btn:hover{color:#ef4444;border-color:rgba(239,68,68,.4)}

/* ── Status Bar ── */
.status-bar{display:flex;align-items:center;justify-content:center;gap:16px;padding:10px 16px;background:rgba(22,27,34,.6)}
.status-pill{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:#9ca3af}
.status-pill .dot{width:8px;height:8px;border-radius:50%;background:#f41216;animation:pulse 2s ease-in-out infinite}
.status-pill.count strong{color:#f41216;font-size:16px}
.refresh-text{font-size:11px;color:#6b7280}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ── Container ── */
.container{max-width:1100px;margin:0 auto;padding:12px}

/* ── Session Cards ── */
.session-grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:560px){.session-grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:900px){.session-grid{grid-template-columns:repeat(3,1fr)}}

.session-card{
    background:rgba(22,27,34,.8);border:1px solid #30363d;border-radius:10px;
    padding:14px 16px;cursor:pointer;transition:border-color .15s,transform .1s;
    position:relative;overflow:hidden;
}
.session-card:hover{border-color:rgba(244,18,22,.4);transform:translateY(-1px)}
.session-card.private{border-left:3px solid rgba(107,114,128,.5)}
.session-card.public{border-left:3px solid rgba(34,197,94,.5)}

.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;gap:6px}
.session-code{font-family:'Consolas','Courier New',monospace;font-size:15px;font-weight:700;letter-spacing:2px;color:#f41216}
.vis-badge{font-size:10px;font-weight:700;letter-spacing:.5px;padding:2px 8px;border-radius:4px}
.vis-badge.public{background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.3)}
.vis-badge.private{background:rgba(107,114,128,.15);color:#9ca3af;border:1px solid rgba(107,114,128,.3)}
.platform-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3)}

.host-name{color:#9ca3af;font-size:13px;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.host-name strong{color:#e5e7eb}

.card-stats{display:flex;gap:12px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:5px;font-size:13px;font-weight:600}
.stat svg{width:15px;height:15px;flex-shrink:0}
.stat.players svg{fill:#3b82f6}.stat.players{color:#3b82f6}
.stat.fires svg{fill:#f41216}.stat.fires{color:#f41216}
.stat.props svg{fill:#22c55e}.stat.props{color:#22c55e}

.card-meta{margin-top:8px;font-size:11px;color:#4b5563;display:flex;gap:10px}

.card-arrow{position:absolute;right:14px;bottom:14px;color:#30363d;transition:color .15s}
.session-card:hover .card-arrow{color:#f41216}

/* ── Empty / Loading ── */
.empty-state{text-align:center;padding:60px 20px}
.empty-state svg{width:64px;height:64px;fill:#30363d;margin-bottom:16px}
.empty-state h3{color:#6b7280;font-size:18px;margin-bottom:8px}
.empty-state p{color:#4b5563;font-size:14px}
.loading{text-align:center;padding:60px 20px;color:#6b7280}
.spinner{width:32px;height:32px;border:3px solid #30363d;border-top-color:#f41216;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.error-toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(239,68,68,.9);color:#fff;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:100;display:none;box-shadow:0 4px 16px rgba(0,0,0,.4)}
.error-toast.visible{display:block}
</style>
</head>
<body>

<!-- Auth Overlay -->
<div class="auth-overlay" id="auth-overlay">
    <div class="auth-box">
        <h2>FS <span>Fire</span> Admin</h2>
        <p>Enter your admin key to view all sessions</p>
        <input type="password" class="auth-input" id="auth-input" placeholder="Admin Key" autocomplete="off"/>
        <button class="auth-btn" id="auth-btn" onclick="doAuth()">AUTHENTICATE</button>
        <div class="auth-error" id="auth-error">Invalid admin key</div>
    </div>
</div>

<!-- Main App (hidden until authenticated) -->
<div id="app" style="display:none;">
    <div class="header">
        <div class="brand">
            <svg viewBox="0 0 24 24"><path d="M12 23c-3.9 0-7-2.8-7-6.3 0-2.2 1.1-4.2 2.8-5.8.4-.4 1-.2 1.1.3.2 1 .6 1.9 1.2 2.7C11.2 11 12 7 12 3c0-.5.5-.8.9-.5C16.5 5.3 19 9.2 19 13.5 19 18.5 16.4 23 12 23z"/></svg>
            <h1>FS <span>Fire</span></h1>
        </div>
        <span class="admin-tag">ADMIN</span>
        <button class="logout-btn" onclick="doLogout()">Logout</button>
    </div>

    <div class="status-bar">
        <div class="status-pill"><span class="dot"></span> ADMIN VIEW</div>
        <div class="status-pill count"><strong id="session-count">—</strong>&nbsp;Sessions</div>
        <div class="refresh-text" id="refresh-text">Refreshing…</div>
    </div>

    <div class="container">
        <div id="content"><div class="loading"><div class="spinner"></div>Loading sessions…</div></div>
    </div>
</div>

<div class="error-toast" id="error-toast"></div>

<script>
(function() {
    'use strict';

    // ═══════════════════════════════════════════
    // CONFIGURATION — Update this to your Cloud Function URL
    // ═══════════════════════════════════════════
    var API_BASE = 'https://us-central1-hotspots-433416.cloudfunctions.net/fsf-multiplayer';
    // ═══════════════════════════════════════════

    var REFRESH_INTERVAL = 15000;
    var adminKey = '';
    var content, countEl, refreshEl, errorToast;
    var countdown = 15;

    // ── Auth ──
    window.doAuth = function() {
        var input = document.getElementById('auth-input');
        var key = input.value.trim();
        if (!key) return;

        // Test the key with an API call
        var xhr = new XMLHttpRequest();
        xhr.open('GET', API_BASE + '/sessions/all?adminKey=' + encodeURIComponent(key), true);
        xhr.timeout = 10000;
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        adminKey = key;
                        sessionStorage.setItem('fsf_admin_key', key);
                        document.getElementById('auth-overlay').style.display = 'none';
                        document.getElementById('app').style.display = 'block';
                        initApp();
                        renderSessions(data.sessions || []);
                        return;
                    }
                } catch (e) {}
            }
            document.getElementById('auth-error').style.display = 'block';
            input.value = '';
            input.focus();
        };
        xhr.onerror = function() {
            document.getElementById('auth-error').textContent = 'Network error';
            document.getElementById('auth-error').style.display = 'block';
        };
        xhr.send();
    };

    window.doLogout = function() {
        sessionStorage.removeItem('fsf_admin_key');
        adminKey = '';
        document.getElementById('app').style.display = 'none';
        document.getElementById('auth-overlay').style.display = 'flex';
        document.getElementById('auth-input').value = '';
        document.getElementById('auth-error').style.display = 'none';
    };

    // Handle Enter key in auth input
    document.getElementById('auth-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') doAuth();
    });

    // Check stored key
    var storedKey = sessionStorage.getItem('fsf_admin_key');
    if (storedKey) {
        adminKey = storedKey;
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        initApp();
        fetchSessions();
    }

    function initApp() {
        content = document.getElementById('content');
        countEl = document.getElementById('session-count');
        refreshEl = document.getElementById('refresh-text');
        errorToast = document.getElementById('error-toast');
        startCountdown();
    }

    function showError(msg) {
        errorToast.textContent = msg;
        errorToast.classList.add('visible');
        setTimeout(function() { errorToast.classList.remove('visible'); }, 4000);
    }

    function escHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

    function timeSince(ts) {
        var mins = Math.floor((Date.now() - ts) / 60000);
        if (mins < 1) return 'Just now';
        if (mins < 60) return mins + 'm ago';
        return Math.floor(mins / 60) + 'h ' + (mins % 60) + 'm';
    }

    function platformLabel(p) {
        if (p === 'msfs2024') return 'MSFS 2024';
        if (p === 'msfs2020') return 'MSFS 2020';
        return p ? p.toUpperCase() : 'MSFS';
    }

    function renderSessions(sessions) {
        countEl.textContent = sessions.length;
        if (sessions.length === 0) {
            content.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M12 23c-3.9 0-7-2.8-7-6.3 0-2.2 1.1-4.2 2.8-5.8.4-.4 1-.2 1.1.3.2 1 .6 1.9 1.2 2.7C11.2 11 12 7 12 3c0-.5.5-.8.9-.5C16.5 5.3 19 9.2 19 13.5 19 18.5 16.4 23 12 23z"/></svg><h3>No Active Sessions</h3><p>No multiplayer sessions running right now.</p></div>';
            return;
        }

        var html = '<div class="session-grid">';
        for (var i = 0; i < sessions.length; i++) {
            var s = sessions[i];
            var vis = s.visibility || 'unknown';
            var detailUrl = 'session.html?id=' + s.sessionId + '&adminKey=' + encodeURIComponent(adminKey);
            html +=
                '<div class="session-card ' + vis + '" onclick="window.location.href=\'' + detailUrl + '\'">' +
                    '<div class="card-header">' +
                        '<span class="session-code">' + s.sessionId + '</span>' +
                        '<span class="vis-badge ' + vis + '">' + vis.toUpperCase() + '</span>' +
                        '<span class="platform-badge">' + platformLabel(s.platform) + '</span>' +
                    '</div>' +
                    '<div class="host-name">Host: <strong>' + escHtml(s.hostName) + '</strong></div>' +
                    '<div class="card-stats">' +
                        '<div class="stat players"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' + s.playerCount + '</div>' +
                        '<div class="stat fires"><svg viewBox="0 0 24 24"><path d="M12 23c-3.9 0-7-2.8-7-6.3 0-2.2 1.1-4.2 2.8-5.8.4-.4 1-.2 1.1.3.2 1 .6 1.9 1.2 2.7C11.2 11 12 7 12 3c0-.5.5-.8.9-.5C16.5 5.3 19 9.2 19 13.5 19 18.5 16.4 23 12 23z"/></svg>' + s.fireCount + '</div>' +
                        '<div class="stat props"><svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>' + s.propCount + '</div>' +
                    '</div>' +
                    '<div class="card-meta">' +
                        '<span>Created: ' + timeSince(s.createdAt) + '</span>' +
                        '<span>Active: ' + timeSince(s.lastActivity) + '</span>' +
                    '</div>' +
                    '<div class="card-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 6 15 12 9 18"/></svg></div>' +
                '</div>';
        }
        html += '</div>';
        content.innerHTML = html;
    }

    function fetchSessions() {
        if (!adminKey) return;
        refreshEl.textContent = 'Refreshing…';

        var xhr = new XMLHttpRequest();
        xhr.open('GET', API_BASE + '/sessions/all?adminKey=' + encodeURIComponent(adminKey), true);
        xhr.timeout = 10000;
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success) { renderSessions(data.sessions || []); countdown = Math.floor(REFRESH_INTERVAL / 1000); }
                    else showError(data.error || 'Failed to load');
                } catch (e) { showError('Invalid response'); }
            } else if (xhr.status === 403) {
                doLogout();
            } else {
                showError('Server error: ' + xhr.status);
            }
        };
        xhr.onerror = function() { showError('Network error'); };
        xhr.send();
    }

    function startCountdown() {
        setInterval(function() {
            countdown--;
            if (countdown <= 0) { fetchSessions(); }
            else { refreshEl.textContent = 'Refresh in ' + countdown + 's'; }
        }, 1000);
    }
})();
</script>
</body>
</html>
