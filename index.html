<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>FS Fire — Active Sessions</title>
<meta name="description" content="Browse active FS Fire multiplayer firefighting sessions for Microsoft Flight Simulator."/>
<meta name="theme-color" content="#0d1117"/>
<style>
/* ── Reset & Base ── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{-webkit-text-size-adjust:100%}
body{
    font-family:-apple-system,'Segoe UI',Helvetica,Arial,sans-serif;
    background:#0d1117;color:#e5e7eb;min-height:100vh;
    -webkit-font-smoothing:antialiased;
}
a{color:#3b82f6;text-decoration:none}
a:hover{text-decoration:underline}

/* ── Header ── */
.header{
    background:#161b22;border-bottom:1px solid #30363d;
    padding:20px 16px 16px;text-align:center;position:sticky;top:0;z-index:10;
}
.header::after{
    content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;
    background:linear-gradient(90deg,transparent,rgba(244,18,22,.3) 50%,transparent);
}
.brand{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px}
.brand img{height:40px;width:auto}
.subtitle{color:#6b7280;font-size:13px;letter-spacing:.3px}

/* ── Status Bar ── */
.status-bar{
    display:flex;align-items:center;justify-content:center;gap:16px;
    padding:10px 16px;background:rgba(22,27,34,.6);
}
.status-pill{
    display:flex;align-items:center;gap:6px;
    font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;
    color:#9ca3af;
}
.status-pill .dot{width:8px;height:8px;border-radius:50%;background:#22c55e;animation:pulse 2s ease-in-out infinite}
.status-pill.count{color:#e5e7eb}
.status-pill.count strong{color:#f41216;font-size:16px}
.refresh-text{font-size:11px;color:#6b7280}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ── Toolbar (Search + Sort) ── */
.toolbar{
    max-width:960px;margin:0 auto;padding:12px 12px 0;
    display:flex;gap:8px;align-items:center;
}
.search-box{
    flex:1;position:relative;
}
.search-box svg{
    position:absolute;left:12px;top:50%;transform:translateY(-50%);
    width:16px;height:16px;color:#6b7280;pointer-events:none;
}
.search-input{
    width:100%;padding:10px 12px 10px 36px;
    background:rgba(22,27,34,.8);border:1px solid #30363d;border-radius:8px;
    color:#e5e7eb;font-size:14px;font-family:inherit;outline:none;
    transition:border-color .15s;
}
.search-input:focus{border-color:rgba(244,18,22,.4)}
.search-input::placeholder{color:#4b5563}

.sort-select{
    padding:10px 32px 10px 12px;
    background:rgba(22,27,34,.8);border:1px solid #30363d;border-radius:8px;
    color:#e5e7eb;font-size:13px;font-weight:600;font-family:inherit;
    outline:none;cursor:pointer;transition:border-color .15s;
    -webkit-appearance:none;-moz-appearance:none;appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right 10px center;
}
.sort-select:focus{border-color:rgba(244,18,22,.4)}

.result-count{
    font-size:12px;color:#6b7280;padding:4px 12px 0;max-width:960px;margin:0 auto;
    display:none;
}
.result-count.visible{display:block}

/* ── Container ── */
.container{max-width:960px;margin:0 auto;padding:8px 12px 12px}

/* ── Session Cards ── */
.session-grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:560px){.session-grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:840px){.session-grid{grid-template-columns:repeat(3,1fr)}}

.session-card{
    background:rgba(22,27,34,.8);border:1px solid #30363d;border-radius:10px;
    padding:14px 16px;cursor:pointer;transition:border-color .15s,transform .1s,background .15s;
    position:relative;overflow:hidden;
}
.session-card:hover{border-color:rgba(244,18,22,.4);background:rgba(22,27,34,1);transform:translateY(-1px)}
.session-card:active{transform:translateY(0)}

.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.session-code{
    font-family:'Consolas','Courier New',monospace;font-size:16px;font-weight:700;
    letter-spacing:2px;color:#f41216;
}
.platform-badge{
    font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;
    padding:3px 8px;border-radius:4px;
    background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3);
}

.host-name{color:#9ca3af;font-size:13px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.host-name strong{color:#e5e7eb}

.card-description{
    color:#6b7280;font-size:12px;font-style:italic;line-height:1.4;
    margin-bottom:8px;
    display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
}

.card-stats{display:flex;gap:12px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:5px;font-size:13px;font-weight:600}
.stat svg{width:16px;height:16px;flex-shrink:0}
.stat.players svg{fill:#3b82f6}
.stat.players{color:#3b82f6}
.stat.fires svg{fill:#f41216}
.stat.fires{color:#f41216}
.stat.props svg{fill:#22c55e}
.stat.props{color:#22c55e}

.card-arrow{
    position:absolute;right:14px;bottom:14px;color:#30363d;transition:color .15s;
}
.session-card:hover .card-arrow{color:#f41216}

/* ── Empty State ── */
.empty-state{
    text-align:center;padding:60px 20px;
}
.empty-state svg{width:64px;height:64px;fill:#30363d;margin-bottom:16px}
.empty-state h3{color:#6b7280;font-size:18px;margin-bottom:8px}
.empty-state p{color:#4b5563;font-size:14px;line-height:1.6}

/* ── Loading ── */
.loading{text-align:center;padding:60px 20px;color:#6b7280}
.spinner{
    width:32px;height:32px;border:3px solid #30363d;border-top-color:#f41216;
    border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Footer ── */
.footer{
    text-align:center;padding:24px 16px;color:#4b5563;font-size:12px;
    border-top:1px solid rgba(48,54,61,.4);margin-top:24px;
}
.footer a{color:#6b7280}

/* ── Error Toast ── */
.error-toast{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    background:rgba(239,68,68,.9);color:#fff;padding:10px 20px;border-radius:8px;
    font-size:13px;font-weight:600;z-index:100;display:none;
    box-shadow:0 4px 16px rgba(0,0,0,.4);
}
.error-toast.visible{display:block}
</style>
</head>
<body>

<div class="header">
    <div class="brand">
        <img src="fsfwhite.png" alt="FS Fire"/>
    </div>
    <div class="subtitle">Active Multiplayer Sessions</div>
</div>

<div class="status-bar">
    <div class="status-pill"><span class="dot"></span> LIVE</div>
    <div class="status-pill count"><strong id="session-count">&mdash;</strong>&nbsp;Sessions</div>
    <div class="refresh-text" id="refresh-text">Refreshing&hellip;</div>
</div>

<div class="toolbar">
    <div class="search-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="search-input" id="search-input" placeholder="Search sessions, hosts, descriptions&hellip;" autocomplete="off"/>
    </div>
    <select class="sort-select" id="sort-select">
        <option value="players">Most Players</option>
        <option value="newest">Newest</option>
        <option value="fires">Most Fires</option>
        <option value="platform_2024">MSFS 2024 First</option>
        <option value="platform_2020">MSFS 2020 First</option>
    </select>
</div>
<div class="result-count" id="result-count"></div>

<div class="container">
    <div id="content">
        <div class="loading"><div class="spinner"></div>Loading sessions&hellip;</div>
    </div>
</div>

<div class="footer">
    Powered by <a href="https://southoakco.com" target="_blank">FS Fire</a> &middot; Firefighting simulation for MSFS
</div>

<div class="error-toast" id="error-toast"></div>

<script>
(function() {
    'use strict';

    var API_BASE = 'https://us-central1-hotspots-433416.cloudfunctions.net/fsf-multiplayer';

    var REFRESH_INTERVAL = 15000;
    var content = document.getElementById('content');
    var countEl = document.getElementById('session-count');
    var refreshEl = document.getElementById('refresh-text');
    var errorToast = document.getElementById('error-toast');
    var searchInput = document.getElementById('search-input');
    var sortSelect = document.getElementById('sort-select');
    var resultCountEl = document.getElementById('result-count');
    var countdown = 15;

    // Raw sessions from API — filtered/sorted on render
    var allSessions = [];

    function showError(msg) {
        errorToast.textContent = msg;
        errorToast.classList.add('visible');
        setTimeout(function() { errorToast.classList.remove('visible'); }, 4000);
    }

    function escHtml(str) {
        var d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }

    function platformLabel(p) {
        if (!p) return 'MSFS';
        if (p === 'msfs2024') return 'MSFS 2024';
        if (p === 'msfs2020') return 'MSFS 2020';
        return p.toUpperCase();
    }

    // ── Filter ──
    function filterSessions(sessions, query) {
        if (!query) return sessions;
        var q = query.toLowerCase();
        return sessions.filter(function(s) {
            var searchable = [
                s.sessionId,
                s.hostName,
                s.description,
                s.platform,
                platformLabel(s.platform)
            ].join(' ').toLowerCase();
            return searchable.indexOf(q) !== -1;
        });
    }

    // ── Sort ──
    function sortSessions(sessions, sortKey) {
        var sorted = sessions.slice();
        switch (sortKey) {
            case 'players':
                sorted.sort(function(a, b) { return b.playerCount - a.playerCount || b.createdAt - a.createdAt; });
                break;
            case 'newest':
                sorted.sort(function(a, b) { return b.createdAt - a.createdAt; });
                break;
            case 'fires':
                sorted.sort(function(a, b) { return b.fireCount - a.fireCount || b.playerCount - a.playerCount; });
                break;
            case 'platform_2024':
                sorted.sort(function(a, b) {
                    var aIs = a.platform === 'msfs2024' ? 0 : 1;
                    var bIs = b.platform === 'msfs2024' ? 0 : 1;
                    return aIs - bIs || b.playerCount - a.playerCount;
                });
                break;
            case 'platform_2020':
                sorted.sort(function(a, b) {
                    var aIs = a.platform === 'msfs2020' ? 0 : 1;
                    var bIs = b.platform === 'msfs2020' ? 0 : 1;
                    return aIs - bIs || b.playerCount - a.playerCount;
                });
                break;
        }
        return sorted;
    }

    // ── Render ──
    function renderSessions() {
        var query = searchInput.value.trim();
        var sortKey = sortSelect.value;

        var filtered = filterSessions(allSessions, query);
        var sorted = sortSessions(filtered, sortKey);

        countEl.textContent = allSessions.length;

        // Show result count only when searching
        if (query && allSessions.length > 0) {
            resultCountEl.textContent = sorted.length + ' of ' + allSessions.length + ' sessions match "' + query + '"';
            resultCountEl.classList.add('visible');
        } else {
            resultCountEl.classList.remove('visible');
        }

        if (allSessions.length === 0) {
            content.innerHTML =
                '<div class="empty-state">' +
                    '<svg viewBox="0 0 24 24"><path d="M12 23c-3.9 0-7-2.8-7-6.3 0-2.2 1.1-4.2 2.8-5.8.4-.4 1-.2 1.1.3.2 1 .6 1.9 1.2 2.7C11.2 11 12 7 12 3c0-.5.5-.8.9-.5C16.5 5.3 19 9.2 19 13.5 19 18.5 16.4 23 12 23z"/></svg>' +
                    '<h3>No Active Sessions</h3>' +
                    '<p>There are no public multiplayer sessions right now.<br/>Start one in FS Fire and it will appear here!</p>' +
                '</div>';
            return;
        }

        if (sorted.length === 0) {
            content.innerHTML =
                '<div class="empty-state">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="#30363d" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' +
                    '<h3>No Matching Sessions</h3>' +
                    '<p>No sessions match your search. Try different keywords.</p>' +
                '</div>';
            return;
        }

        var html = '<div class="session-grid">';
        for (var i = 0; i < sorted.length; i++) {
            var s = sorted[i];
            var desc = s.description ? '<div class="card-description">' + escHtml(s.description) + '</div>' : '';
            html +=
                '<div class="session-card" onclick="window.location.href=\'session.html?id=' + s.sessionId + '\'">' +
                    '<div class="card-header">' +
                        '<span class="session-code">' + s.sessionId + '</span>' +
                        '<span class="platform-badge">' + platformLabel(s.platform) + '</span>' +
                    '</div>' +
                    '<div class="host-name">Host: <strong>' + escHtml(s.hostName) + '</strong></div>' +
                    desc +
                    '<div class="card-stats">' +
                        '<div class="stat players"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' + s.playerCount + '</div>' +
                        '<div class="stat fires"><svg viewBox="0 0 24 24"><path d="M12 23c-3.9 0-7-2.8-7-6.3 0-2.2 1.1-4.2 2.8-5.8.4-.4 1-.2 1.1.3.2 1 .6 1.9 1.2 2.7C11.2 11 12 7 12 3c0-.5.5-.8.9-.5C16.5 5.3 19 9.2 19 13.5 19 18.5 16.4 23 12 23z"/></svg>' + s.fireCount + '</div>' +
                        '<div class="stat props"><svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>' + s.propCount + '</div>' +
                    '</div>' +
                    '<div class="card-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 6 15 12 9 18"/></svg></div>' +
                '</div>';
        }
        html += '</div>';
        content.innerHTML = html;
    }

    // ── Search & Sort event handlers ──
    searchInput.addEventListener('input', renderSessions);
    sortSelect.addEventListener('change', renderSessions);

    // ── Fetch ──
    function fetchSessions() {
        refreshEl.textContent = 'Refreshing\u2026';

        var xhr = new XMLHttpRequest();
        xhr.open('GET', API_BASE + '/sessions/public', true);
        xhr.timeout = 10000;
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        allSessions = data.sessions || [];
                        renderSessions();
                        countdown = Math.floor(REFRESH_INTERVAL / 1000);
                    } else {
                        showError(data.error || 'Failed to load sessions');
                    }
                } catch (e) {
                    showError('Invalid response from server');
                }
            } else {
                showError('Server error: ' + xhr.status);
            }
        };
        xhr.onerror = function() { showError('Network error \u2014 check your connection'); };
        xhr.ontimeout = function() { showError('Request timed out'); };
        xhr.send();
    }

    function startCountdown() {
        setInterval(function() {
            countdown--;
            if (countdown <= 0) {
                fetchSessions();
            } else {
                refreshEl.textContent = 'Refresh in ' + countdown + 's';
            }
        }, 1000);
    }

    fetchSessions();
    startCountdown();
})();
</script>
</body>
</html>
